<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-features/multistage-programming" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Multistage programming | The Terra Programming Language</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://github.com/terra-website/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://github.com/terra-website/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://github.com/terra-website/docs/features/multistage-programming"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Multistage programming | The Terra Programming Language"><meta data-rh="true" name="description" content="Multistage programming lies at the heart of Terra&#x27;s design, empowering developers to create code that dynamically generates and specializes other code at compile time. By elevating Terra&#x27;s functions, types, variables, and expressions to first-class citizens within Lua, this approach facilitates seamless code construction, optimization, and adaptation."><meta data-rh="true" property="og:description" content="Multistage programming lies at the heart of Terra&#x27;s design, empowering developers to create code that dynamically generates and specializes other code at compile time. By elevating Terra&#x27;s functions, types, variables, and expressions to first-class citizens within Lua, this approach facilitates seamless code construction, optimization, and adaptation."><link data-rh="true" rel="icon" href="/terra-website/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://github.com/terra-website/docs/features/multistage-programming"><link data-rh="true" rel="alternate" href="https://github.com/terra-website/docs/features/multistage-programming" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/terra-website/docs/features/multistage-programming" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/terra-website/blog/rss.xml" title="The Terra Programming Language RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/terra-website/blog/atom.xml" title="The Terra Programming Language Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/terra-website/assets/css/styles.a8638691.css">
<script src="/terra-website/assets/js/runtime~main.52d837b6.js" defer="defer"></script>
<script src="/terra-website/assets/js/main.d1ac73a1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/terra-website/img/terra-logo-light.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/terra-website/"><div class="navbar__logo"><img src="/terra-website/img/terra-logo-light.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/terra-website/img/terra-logo-light.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a><a href="https://github.com/terralang/terra/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Download<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/terra-website/docs/getting-started/intro">About</a><a class="navbar__item navbar__link" href="/terra-website/docs/getting-started/intro">Getting started</a><a class="navbar__item navbar__link" href="/terra-website/docs/getting-started/intro">Documentation</a><a class="navbar__item navbar__link" href="/terra-website/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terralang/terra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Multistage programming in Terra</h1></header>
<p>Multistage programming lies at the heart of Terra&#x27;s design, empowering developers to create code that dynamically generates and specializes other code at compile time. By elevating Terra&#x27;s functions, types, variables, and expressions to first-class citizens within Lua, this approach facilitates seamless code construction, optimization, and adaptation.</p>
<p>The design of Terra stems from the insight that C/C++ effectively comprises multiple &quot;languages&quot;: a core language of operators, control flow, and function calls, surrounded by a fragmented meta-language including the preprocessor, templating system, and struct definitions. While C++ templates are Turing-complete and have enabled optimized libraries like Eigen, they are notoriously cumbersome in practice.</p>
<p>Terra embraces and extends this approach by replacing C/C++&#x27;s ad-hoc meta-language with a full-fledged programming language: Lua. This pairing of a low-level systems language with a high-level scripting language unlocks capabilities beyond traditional systems. Unlike C/C++, Terra code can be JIT-compiled and executed interleaved with Lua, simplifying the creation of libraries that rely on runtime code generation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-language-features">High-level Language features<a href="#high-level-language-features" class="hash-link" aria-label="Direct link to High-level Language features" title="Direct link to High-level Language features">​</a></h2>
<p>As a result, features from other languages—such as conditional compilation and templating—emerge organically from Lua&#x27;s metaprogramming of Terra. For example, templated types, akin to C++ templates but far more flexible, arise through Lua&#x27;s dynamic code generation, supporting parameterized structs and functions without rigid syntax. Arbitrary compile-time computations, like producing optimized kernels based on runtime parameters or domain-specific abstractions, become simple Lua scripts that seamlessly integrate high-performance Terra code with expressive metaprogramming.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Conditional compilation </summary><div><div class="collapsibleContent_i85q"><p>Conditional compilation is done with control-flow that determines what code is defined.</p><div style="display:flex;gap:1rem;flex-wrap:wrap"><div style="flex:1;min-width:300px"><div style="color:var(--ifm-font-color-base);padding:0.5rem 1rem;border-radius:var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px) 0 0;border-bottom:none;font-size:0.9rem;font-weight:bold">Terra</div><div style="margin-top:0;border-radius:0 0 var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px);overflow:hidden"><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div></div></div><div style="flex:1;min-width:300px"><div style="color:var(--ifm-font-color-base);padding:0.5rem 1rem;border-radius:var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px) 0 0;border-bottom:none;font-size:0.9rem;font-weight:bold">C++</div><div style="margin-top:0;border-radius:0 0 var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px);overflow:hidden"><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">_WIN32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">waitatend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">getchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">waitatend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Templated types</summary><div><div class="collapsibleContent_i85q"><p>Templates become Lua functions that take a terra type T and use it to generate new types and code.</p><div style="display:flex;gap:1rem;flex-wrap:wrap"><div style="flex:1;min-width:300px"><div style="color:var(--ifm-font-color-base);padding:0.5rem 1rem;border-radius:var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px) 0 0;border-bottom:none;font-size:0.9rem;font-weight:bold">Terra</div><div style="margin-top:0;border-radius:0 0 var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px);overflow:hidden"><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div></div></div><div style="flex:1;min-width:300px"><div style="color:var(--ifm-font-color-base);padding:0.5rem 1rem;border-radius:var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px) 0 0;border-bottom:none;font-size:0.9rem;font-weight:bold">C++</div><div style="margin-top:0;border-radius:0 0 var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px);overflow:hidden"><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Array</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> N</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> FloatArray</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Namespaces</summary><div><div class="collapsibleContent_i85q"><p>Statically-typed languages normally need constructs that specifically deal with the problem of namespaces (e.g., C++&#x27;s <code>namespace</code> keyword, or Java&#x27;s <code>import</code> constructs). For Terra, we just use Lua&#x27;s first-class tables as way to organize functions. When you use any &quot;name&quot; such as <code>myfunctions.add</code> inside a Terra function, the Terra will resolve it at <em>compile time</em> to the Terra value it holds. Here is an example of placing a Terra function inside a Lua table, and then calling it from another Terra function:</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>In fact, you&#x27;ve already seen this behavior when we imported C functions:</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>The function <code>includec</code> just returns a Lua table (<code>C</code>) that contains the C functions. Since <code>C</code> is a Lua table, you can iterate through it if you want:</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-code-generation-and-optimization">Dynamic Code Generation and Optimization<a href="#dynamic-code-generation-and-optimization" class="hash-link" aria-label="Direct link to Dynamic Code Generation and Optimization" title="Direct link to Dynamic Code Generation and Optimization">​</a></h2>
<p>Multistage programming further empowers Terra to dynamically generate code tailored to specific scenarios, such as functions optimized for input sizes, hardware targets, or constraints. This is invaluable for tasks like loop unrolling, constant folding, or SIMD vectorization, all orchestrated via Lua for efficient, adaptive execution.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: loop unrolling in polynomial evaluation</summary><div><div class="collapsibleContent_i85q"><p>We explore loop unrolling in Terra for evaluating a cubic polynomial <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>a</mi><mo>+</mo><mi>b</mi><mo>⋅</mo><mi>x</mi><mo>+</mo><mi>c</mi><mo>⋅</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mi>d</mi><mo>⋅</mo><msup><mi>x</mi><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">p(x) = a + b \cdot x + c \cdot x^2 + d \cdot x^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span>, where coefficients are stored in a struct array (<code>coeffs[0] = a</code>, <code>coeffs[1] = b</code>,  <code>coeffs[2] = c</code>,  <code>coeffs[3] = d</code>.). Horner&#x27;s method rewrites the polynomial as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>+</mo><mi>x</mi><mo>⋅</mo><mo stretchy="false">(</mo><mi>b</mi><mo>+</mo><mi>x</mi><mo>⋅</mo><mo stretchy="false">(</mo><mi>c</mi><mo>+</mo><mi>x</mi><mo>⋅</mo><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a + x \cdot (b + x \cdot (c + x \cdot d))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">d</span><span class="mclose">))</span></span></span></span> to minimize multiplications and additions, improving numerical stability and performance.</p><p>Terra&#x27;s metaprogramming capabilities allow us to unroll loops at compile time, generating explicit, optimized code without runtime overhead. The following code defines a generic, templated Polynomial evaluator supporting float or double types. It uses loop unrolling in the eval method to produce efficient, branch-free code.</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>To create a cubic polynomial type with float coefficients:</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>Inspect the unrolled eval method using <code>:printpretty()</code> to see the expanded Terra code:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:31:     terra poly.eval(self : &amp;poly,x : float) : float</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:32:         var y : float = [&amp;float]((@self).coeffs)[3] -- c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:36:         y = x * y + [&amp;float]((@self).coeffs)[2]     -- x*d + c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:36:         y = x * y + [&amp;float]((@self).coeffs)[1]     -- x*(x*d + c) + b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:36:         y = x * y + [&amp;float]((@self).coeffs)[0]     -- x*(x*(x*d + c) + b) + a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:40:         return y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tutorial-poly.t:31:     end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This shows the loop fully unrolled into sequential multiply-adds, ready for further optimization by the compiler.</p><p>View the generated assembly with <code>:disas()</code> (with -O3 on an AMD CPU):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">assembly for function at address 0x722b5a3bb000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb000(+0):             vmulsd  xmm1, xmm0, qword ptr [rdi + 24]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb005(+5):             vaddsd  xmm1, xmm1, qword ptr [rdi + 16]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb00a(+10):            vmulsd  xmm1, xmm1, xmm0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb00e(+14):            vaddsd  xmm1, xmm1, qword ptr [rdi + 8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb013(+19):            vmulsd  xmm0, xmm1, xmm0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb017(+23):            vaddsd  xmm0, xmm0, qword ptr [rdi]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x722b5a3bb01b(+27):            ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This code is already quite efficient with 7 instructions (3 multiplies, 3 adds, 1 return) and 3 registers (an input/output register <code>xmm0</code>, a register <code>xmm1</code> to hold a temporary, and a general purpose register <code>rdi</code> to point to the coefficient array).</p></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Optimizing with LLVM Intrinsics for fused-multiply-addition (FMA) </summary><div><div class="collapsibleContent_i85q"><p>We can further optimize the code of the previous example by fusing the addition and multiplication into one operation. The intrinsic (llvm.fma.f64 or llvm.fma.f32) ensures the compiler emits hardware FMA instructions (e.g., vfmadd213sd), reducing instruction count, latency, and rounding errors.</p><p>Here&#x27;s the optimized code integrated into the Polynomial factory (replace the original eval method and add the intrinsic definition):</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>The Terra intrinsic declaration maps directly to LLVM&#x27;s FMA operation, selecting <code>llvm.fma.f32</code> for floats or <code>llvm.fma.f64</code> for doubles based on type <code>T</code>. It takes three <code>T</code> arguments (x, y, z) and returns <code>T</code>, computing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>⋅</mo><mi>y</mi><mo>+</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">x \cdot y + z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span>—perfect for Horner&#x27;s nesting. This results in the following assembly with 5 instructions and 3 fused-multiply-adds.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">assembly for function at address 0x736c9cc8a000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x736c9cc8a000(+0):             vmovsd  xmm1, qword ptr [rdi + 24]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x736c9cc8a005(+5):             vfmadd213sd     xmm1, xmm0, qword ptr [rdi + 16]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x736c9cc8a00b(+11):            vfmadd213sd     xmm1, xmm0, qword ptr [rdi + 8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x736c9cc8a011(+17):            vfmadd213sd     xmm0, xmm1, qword ptr [rdi]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x736c9cc8a016(+22):            ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-compiler-features-as-libraries">Implementing Compiler Features as Libraries<a href="#implementing-compiler-features-as-libraries" class="hash-link" aria-label="Direct link to Implementing Compiler Features as Libraries" title="Direct link to Implementing Compiler Features as Libraries">​</a></h2>
<p>Multistage programming empowers users to implement language extensions—typically reserved for compiler developers—as simple Lua libraries. This capability stems from Terra&#x27;s design: Lua serves as a staging language to generate and specialize Terra code dynamically at compile time. Features like lambdas, generics, or custom optimizations can be built modularly without altering the core compiler, enabling rapid prototyping, better portability, and user-defined DSLs. It&#x27;s even possible to extend Terra&#x27;s parser from outside the language by adding new keywords with associated logic in a library. This library-based approach democratizes language design, shifting complexity from monolithic compilers to reusable modules, and reduces overhead by generating efficient, specialized code on-the-fly.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Implementing Lambdas as a Library in Terra </summary><div><div class="collapsibleContent_i85q"><p>In traditional languages, lambdas (anonymous functions with captures) require compiler support for closure creation, variable capturing, and invocation. In Terra, multistage programming allows this to be implemented concisely as a Lua library using macros and structs. The following code creates function objects that wrap a Terra function, capture variables in a struct, and overload the apply metamethod for invocation. It&#x27;s only a few lines, demonstrating the power of multistage programming to implement compiler features.</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>By loading this small library you can define and use lambda&#x27;s as follows:</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Implementing Run-Time Type Information (RTTI) as a Library in Terra </summary><div><div class="collapsibleContent_i85q"><p>In C++, Run-Time Type Information (RTTI) is a built-in language feature implemented in the compiler for dynamic type checking and casting. In Terra, multistage programming allows RTTI to be implemented entirely as a Lua library outside the compiler, adding type IDs to structs and enabling dynamic casts with minimal code.</p><p>RTTI provides run-time identification of object types, useful for dynamic casting or polymorphism. The library assigns unique IDs to types, inserts them as fields in structs, and offers functions for querying and casting—mirroring C++&#x27;s typeid and dynamic_cast but in a lightweight, user-extensible module.</p><p>Implementing RTTI as a library benefits from modularity (easy updates without recompiling Terra), portability (no compiler dependencies), and customization (users can modify ID generation or add features). It leverages Lua&#x27;s metaprogramming to insert fields and initializers dynamically, demonstrating how multistage programming shifts compiler-like features to libraries.</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div><p>The following test demonstrates dynamic casting: <code>f</code> identifies and prints the type of opaque pointers to <code>A</code> or <code>B</code> instances by performing a dynamic cast.</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Concept-Based Template Dispatch as a Library Extension </summary><div><div class="collapsibleContent_i85q"><p>Template dispatch selects the appropriate function overload at compile time based on argument types and constraints, improving type safety and expressiveness. Concepts define requirements on template parameters (e.g., Real for floating-point types, Integer for integers), ensuring only valid instantiations are allowed and providing clear error messages for mismatches.</p><p>The new standard library implements templated overloading of functions and methods, with template constraints via concepts—mirroring C++20&#x27;s capabilities but in a modular library. This library uses Terra&#x27;s unique feature to extend the parser from outside the language with a new keyword, <code>terraform</code>, with the dispatch logic implemented in the library.</p><p>Implementing this as a library offers key benefits: modularity (easy to update or replace), no core compiler modifications (faster iteration, better portability), and extensibility (users can add custom concepts or dispatch rules). It leverages Lua&#x27;s metaprogramming to generate specialized code, reducing runtime overhead while keeping the language lightweight.</p><div class="terra-code-container" style="position:relative"><pre class="language-terra"><code></code></pre><button class="terra-copy-btn" aria-label="Copy code to clipboard"><svg viewBox="0 0 24 24" class="copy-icon"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copied-icon"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></button></div></div></div></details></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/features/multistage-programming.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#high-level-language-features" class="table-of-contents__link toc-highlight">High-level Language features</a></li><li><a href="#dynamic-code-generation-and-optimization" class="table-of-contents__link toc-highlight">Dynamic Code Generation and Optimization</a></li><li><a href="#implementing-compiler-features-as-libraries" class="table-of-contents__link toc-highlight">Implementing Compiler Features as Libraries</a></li></ul></div></div></div><div class="navigationContainer_MZYS"><div class="navArrows_zGQG"><a class="navLink_khJ7" href="/terra-website/docs/features/script-with-c-performance">← Previous</a><span class="spacer_eUuD"></span><a class="navLink_khJ7" href="/terra-website/docs/features/backwards-compatible-with-c">Next →</a></div><a class="homeLink_Zq3u" href="/terra-website/">Back to Home</a></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/terra-website/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/terra-website/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/terralang/terra" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Terralang.</div></div></div></footer></div>
</body>
</html>