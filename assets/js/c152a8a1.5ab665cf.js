"use strict";(self.webpackChunkterra_website=self.webpackChunkterra_website||[]).push([[5503],{8453:(e,a,n)=>{n.d(a,{R:()=>s,x:()=>l});var r=n(6540);const i={},t=r.createContext(i);function s(e){const a=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function l(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(t.Provider,{value:a},e.children)}},8810:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>g});const r=JSON.parse('{"id":"features/multistage-programming","title":"Multistage programming","description":"Terra is a low-level system programming language that is embedded in and meta-programmed by the Lua programming language:","source":"@site/docs/features/multistage-programming.mdx","sourceDirName":"features","slug":"/features/multistage-programming","permalink":"/terra-website/docs/features/multistage-programming","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/features/multistage-programming.mdx","tags":[],"version":"current","frontMatter":{"id":"multistage-programming","title":"Multistage programming"}}');var i=n(4848),t=n(8453);n(6540);const s=e=>{let{children:a}=e;return(0,i.jsx)("div",{style:{display:"flex",gap:"1rem",flexWrap:"wrap"},children:a})},l=e=>{let{children:a,title:n}=e;return(0,i.jsxs)("div",{style:{flex:1,minWidth:"300px"},children:[n&&(0,i.jsx)("div",{style:{color:"var(--ifm-font-color-base)",padding:"0.5rem 1rem",borderRadius:"var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px) 0 0",borderBottom:"none",fontSize:"0.9rem",fontWeight:"bold"},children:n}),(0,i.jsx)("div",{style:{marginTop:n?"0":"inherit",borderRadius:n?"0 0 var(--ifm-pre-border-radius, 4px) var(--ifm-pre-border-radius, 4px)":"var(--ifm-pre-border-radius, 4px)",overflow:"hidden"},children:a})]})},o={id:"multistage-programming",title:"Multistage programming"},d="Multistage programming",c={},g=[{value:"How can you use Terra?",id:"how-can-you-use-terra",level:2},{value:"An embedded JIT-compiler for building languages",id:"an-embedded-jit-compiler-for-building-languages",level:3},{value:"A scripting-language with high-performance extensions",id:"a-scripting-language-with-high-performance-extensions",level:3},{value:"A stand-alone low-level language",id:"a-stand-alone-low-level-language",level:3},{value:"Generative Programming",id:"generative-programming",level:2},{value:"Compiling-a-language",id:"compiling-a-language",level:2},{value:"Embedding-and-interoperability",id:"embedding-and-interoperability",level:2},{value:"Simplicity (#simplicity)",id:"simplicity-simplicity",level:2}];function m(e){const a={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.header,{children:(0,i.jsx)(a.h1,{id:"multistage-programming",children:"Multistage programming"})}),"\n",(0,i.jsxs)(a.p,{children:[(0,i.jsx)(a.strong,{children:"Terra"})," is a low-level system programming language that is embedded in and meta-programmed by the ",(0,i.jsx)(a.strong,{children:"Lua"})," programming language:"]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-terra",children:'--This top-level code is plain Lua code.\nfunction printhello()\n    -- This is a plain Lua function\n    print("Hello, Lua!")\nend\nprinthello()\n\n-- Terra is backwards compatible with C, we\'ll use C\'s io library in our example.\nC = terralib.includec("stdio.h")\n\n-- The keyword \'terra\' introduces a new Terra function.\nterra hello(argc : int, argv : &rawstring)\n    -- Here we call a C function from Terra\n    C.printf("Hello, Terra!\\n")\n    return 0\nend\n\n-- You can call Terra functions directly from Lua, they are JIT compiled \n-- using LLVM to create machine code\nhello(0,nil)\n\n-- Terra functions are first-class values in Lua, and can be introspected \n-- and meta-programmed using it\nhello:disas()\n--[[ output:\n    assembly for function at address 0x60e6010\n    0x60e6010(+0):\t\tpush\trax\n    0x60e6011(+1):\t\tmovabs\trdi, 102129664\n    0x60e601b(+11):\t\tmovabs\trax, 140735712154681\n    0x60e6025(+21):\t\tcall\trax\n    0x60e6027(+23):\t\txor\teax, eax\n    0x60e6029(+25):\t\tpop\trdx\n    0x60e602a(+26):\t\tret\n]]\n\n-- You can save Terra code as executables, object files, or shared libraries \n-- and link them into existing programs\nterralib.saveobj("helloterra",{ main = hello })\n'})}),"\n",(0,i.jsxs)(a.p,{children:["Try this example and others in your browser via ",(0,i.jsx)(a.a,{href:"https://replit.com/@terralang/terra",children:"Replit"}),"."]}),"\n",(0,i.jsxs)(a.p,{children:["Like C/C++, Terra is a  ",(0,i.jsx)(a.strong,{children:"statically-typed"}),", ",(0,i.jsx)(a.strong,{children:"compiled language"})," with manual memory management.\nBut unlike C/C++, it is designed from the beginning to be ",(0,i.jsx)(a.strong,{children:"meta-programmed from Lua"}),"."]}),"\n",(0,i.jsxs)(a.p,{children:['The design of Terra comes from the realization that C/C++ is really composed of multiple "languages." It has a core language of operators, control-flow, and functions calls, but surrounding this language is a meta-language composed of a mix of features such as the pre-processor, templating system, and struct definitions. Templates alone are Turing-complete and have been used to produce optimized libraries such as ',(0,i.jsx)(a.a,{href:"http://eigen.tuxfamily.org/index.php?title=Main_Page",children:"Eigen"}),", but are horrible to use in practice."]}),"\n",(0,i.jsx)(a.p,{children:"In Terra, we just gave in to the trend of making the meta-language of C/C++ more powerful and replaced it with a real programming language, Lua."}),"\n",(0,i.jsx)(a.p,{children:"The combination of a low-level language meta-programmed by a high-level scripting language allows many behaviors that are not possible in other systems. Unlike C/C++, Terra code can be JIT-compiled and run interleaved with Lua evaluation, making it easy to write software libraries that depend on runtime code generation."}),"\n",(0,i.jsx)(a.p,{children:"Features of other languages such as conditional compilation and templating simply fall out of the combination of using Lua to meta-program Terra:"}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)(l,{title:"Terra",children:(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-terra",children:"terra add(a : int,b : int) : int\n    return a + b\nend\n"})})}),(0,i.jsx)(l,{title:"C++",children:(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-cpp",children:"int add(int a, int b) {\n    return a + b;\n}\n"})})})]}),"\n",(0,i.jsx)(a.p,{children:"Conditional compilation is done with control-flow that determines what code is defined."}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)(l,{children:(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-terra",children:"if iswindows() then\n    terra waitatend()\n        C.getchar()\n    end\nelse\n    terra waitatend() end\nend\n"})})}),(0,i.jsx)(l,{children:(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-cpp",children:"#ifdef _WIN32\n    void waitatend() { \n        getchar(); \n    }\n#else\n    void waitatend() {}\n#endif\n"})})})]}),"\n",(0,i.jsx)(a.p,{children:"Templates become Lua functions that take a terra type T and use it to generate new types and code."}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)(l,{children:(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-terra",children:"function Array(T)\n    struct Array {\n        N : int\n        data : &T\n    }\n    terra Array:get(i : int)\n        return self.data[i]\n    end\n    return Array\nend\n\nFloatArray = Array(float)\n"})})}),(0,i.jsx)(l,{children:(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-cpp",children:"template<class T>\nstruct Array {\n    int N;\n    T* data;\n\n    T get(int i) {\n        return data[i];\n    }\n\n};\n\ntypedef Array<float> FloatArray;\n"})})})]}),"\n",(0,i.jsx)(a.h2,{id:"how-can-you-use-terra",children:"How can you use Terra?"}),"\n",(0,i.jsx)(a.p,{children:"Terra is a statically-typed, compiled language that interoperates seamlessly with Lua. In this setup, Lua acts as the high-level meta-programming layer, while Terra handles the low-level, performance-critical code. The two languages share a lexical environment, meaning Terra code is written within Lua programs, and Lua can dynamically generate and manipulate Terra code at runtime. You can use Terra and Lua in the followind way ..."}),"\n",(0,i.jsx)(a.h3,{id:"an-embedded-jit-compiler-for-building-languages",children:"An embedded JIT-compiler for building languages"}),"\n",(0,i.jsxs)(a.p,{children:["We use techniques from ",(0,i.jsx)(a.a,{href:"https://en.wikipedia.org/wiki/Multi-stage_programming",children:"multi-stage programming"})," to make it possible to  ",(0,i.jsx)(a.a,{href:"#generative-programming",children:"meta-program"})," Terra using Lua.  Terra expressions, types, and functions are all first-class Lua values, making it possible to generate arbitrary programs at runtime. This allows you to ",(0,i.jsx)(a.a,{href:"#compiling-a-language",children:"compile domain-specific languages"})," (DSLs) written in Lua into high-performance Terra code. Furthermore, since Terra is built on the Lua ecosystem, it is easy to ",(0,i.jsx)(a.a,{href:"#embedding-and-interoperability",children:"embed"})," Terra-Lua programs in other software as a library. This design allows you to add a JIT-compiler into your existing software. You can use it to add a JIT-compiled DSL to your application, or to auto-tune high-performance code dynamically."]}),"\n",(0,i.jsx)(a.h3,{id:"a-scripting-language-with-high-performance-extensions",children:"A scripting-language with high-performance extensions"}),"\n",(0,i.jsx)(a.p,{children:"While the performance of Lua and other dynamic languages is always getting better, a low-level of abstraction gives you predictable control of performance when you need it. Terra programs use the same LLVM backend that Apple uses for its C compilers. This means that Terra code performs similarly to equivalent C code. Terra also includes built-in support for SIMD operations, and other low-level features like non-temporal writes and prefetches. You can use Lua to organize and configure your application, and then call into Terra code when you need controllable performance."}),"\n",(0,i.jsx)(a.h3,{id:"a-stand-alone-low-level-language",children:"A stand-alone low-level language"}),"\n",(0,i.jsxs)(a.p,{children:["Terra was designed so that it can run independently from Lua. In fact, if your final program doesn't need Lua, you can save Terra code into a .o file or executable. In addition to ensuring a clean separation between high- and low-level code, this design lets you use Terra as a stand-alone low-level language. In this use-case, Lua serves as a powerful meta-programming language.  Here it serves as a replacement for C++ ",(0,i.jsx)(a.a,{href:"https://en.wikipedia.org/wiki/Template_metaprogramming",children:"template metaprogramming"})," or C preprocessor ",(0,i.jsx)(a.a,{href:"https://en.wikipedia.org/wiki/X_macro",children:"X-Macros"})," with better syntax and nicer properties such as ",(0,i.jsx)(a.a,{href:"https://en.wikipedia.org/wiki/Hygienic_macro",children:"hygiene"}),". Since Terra exists ",(0,i.jsx)(a.em,{children:"only"})," as code embedded in a Lua meta-program, features that are normally built into low-level languages can be implemented as Lua libraries. This design keeps the core of Terra simple, while enabling powerful behavior such as conditional compilation, namespaces, templating, and even ",(0,i.jsx)(a.strong,{children:"class systems"})," ",(0,i.jsx)(a.strong,{children:(0,i.jsx)(a.a,{href:"#simplicity",children:"implemented as libraries"})}),"."]}),"\n",(0,i.jsx)(a.h2,{id:"generative-programming",children:"Generative Programming"}),"\n",(0,i.jsx)(a.p,{children:"Placeholder text"}),"\n",(0,i.jsx)(a.h2,{id:"compiling-a-language",children:"Compiling-a-language"}),"\n",(0,i.jsx)(a.p,{children:"Placeholder text"}),"\n",(0,i.jsx)(a.h2,{id:"embedding-and-interoperability",children:"Embedding-and-interoperability"}),"\n",(0,i.jsx)(a.p,{children:"Placeholder text"}),"\n",(0,i.jsx)(a.h2,{id:"simplicity-simplicity",children:"Simplicity (#simplicity)"})]})}function u(e={}){const{wrapper:a}={...(0,t.R)(),...e.components};return a?(0,i.jsx)(a,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}}}]);